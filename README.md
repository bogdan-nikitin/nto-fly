# Quadroteam

Перед нашей командой стояла непростая задача, а именно, чтобы дрон в автономном режиме распознал QR-код, в котором были заложены координаты начала трубопровода, обнаружил нефтепровод, с последующим распознанием дефектов на нём, обнаружил разлив нефти. При этом дефекты и разлив должны быть выделены контуром.  
После обнаружения выше перечисленного, перед нами стояла задача собрать пробы воды, для последующего анализа на загрязнение, при этом нужно было разработать устройство, при помощи которого дрон в автономном режиме смог бы собрать пробу воды и без потерь доставить её в зону посадки. После всей проделанной работы дрон должен вывести отчёт, в котором должны быть координаты дефектов и площадь разлива, для понимания катастрофы.

Порядок действий в программе:
1. Взлёт на 0.5 метра по body и одновременный поиск QR-кода  
Распознавание QR-кода осуществляется с помощью библиотеки pyzbar
2. Запоминаем позицию старта (по aruco\_map)
3. После нахождения QR-кода - движение по aruco\_map к точке, указанной в QR-коде
4. Поворот коптера в сторону следования линии
5. Движение по линии: с помощью OpenCV находим линию и задаём коптеру скорость по y и скорость поворота, пропорционально отклонению линии от центра в кадре  
Одновременно с этим поиск пробоев: в списке храним информацию про пробои - расстояние в пикселях от пробоя до центра кадра, позицию пробоя на aruco\_map и площадь разлива. С помощью OpenCV находим пробой, проверяем, есть ли он в списке найденных пробоев (с некоторой погрешностью DEFECT\_MIN\_DIST), если есть:  
сравниваем расстояние до центра экрана. Если оно меньше текущего, обновляем позицию на aruco\_map (пробой ближе к центру кадра, значит дрон находится ближе к пробою). В качестве позиции берём позицию коптера.
Если нет, то добавляем в список пробоев.  
Если в кадре есть разлив, и пробой новый (т.е. отсутствует в списке), выводим площадь на экран. Иначе обновляем площадь.
Во время полёта задаём вертикальную скорость пропорционально отклонению высоты по aruco\_map от LINE\_FLY\_HEIGHT. Высоту находим по дальномеру.
Для нахождения пробоев и разливов накладываем цветовую маску на изображение из топика /main\_camera/image\_raw\_throttled и по ней определяем контуры, площадь в пикселях ищем средствами OpenCV (cv2.contourArea).
6. Как только линия пропала из кадра, перемещаемся в точку над стартом (через навигацию)
7. Производим посадку по QR-коду: задаём скорости по x и y пропорционально отклонению QR-кода от центра кадра. При исчезновении QR-кода вызываем land()
8. Выводим отчёт


Перед пролетом по трубопроводу мы определяем, где находится на его край на границе изображения и поворачиваемся к нему.
Для пролета по линии мы сначала накладываем цветовую маску на изображение из топика /main\_camera/image\_raw\_throttled и по ней определяем контуры трубопровода. Далее ищется самый большой контур по количеству точек. Во круг него определяется прямоугольник, который определяет направление движения. После чего данный алгоритм повторяется, пока мы не долетим до конца линии.
Площадь разлива измеряется с помощью уравнения S=4\*h2\*a\*T/(320*240), где h - высота над поверхностью, a – площадь в пикселях, T – произведение тангенсов половин углов обзора камеры. Экспериментально в gazebo было выяснено, что T≈2.5097620554147357.